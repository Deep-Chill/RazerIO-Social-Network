{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}Home{% endblock %}

{% block content %}
{% if user.is_authenticated %}

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{ user.username }}</h5>
          <a href="{% url 'profile' user.id %}" class="btn btn-primary">Profile</a>
          <a href="{% url 'logout' %}" class="btn btn-primary">Logout</a>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-secondary">Alerts</button>
        <button class="btn btn-secondary">Messages</button>
      </div>
    </div>
    <div class="col-sm-5">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">News</h5>
        </div>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="card">
        <div class="card-body">
          <div id="post-list">
            <h1>Social Feed:</h1>
            {% for i in Posts %}
            <a href="{% url 'profile' i.Author.id %}">{{ i.Author }}</a> wrote: {{ i.Text }}<br>
            {% empty %}
            No posts yet!
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<form id="new-post-form" method="POST">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-success">Create Post</button>
</form>
<script>
  function submitForm() {
    $.ajax({
      type: "POST",
      url: window.location.href,
      data: $("#new-post-form").serialize(),
      success: function(response) {
        // Clear the form fields
        $("#id_Text").val("");
        $("#id_Category").val("");
        // Add the new post to the top of the post list
        $("#post-list").prepend(response);
      },
      error: function(response) {
        console.log("Error:", response);
      }
    });
  }

  $(function() {
    // Bind the submitForm() function to the form's submit event
    $('#new-post-form').on('submit', function(event) {
      event.preventDefault();
      submitForm();
    });

    // Connect to a WebSocket server for real-time updates
    const socket = new WebSocket('ws://' + window.location.host + '/ws/posts/');
    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      // Add the new post to the top of the post list
      $("#post-list").prepend(data.html);
    };
  });
</script>
{% else %}

<p>You are not logged in</p>
<a href="{% url 'login' %}" class="btn btn-primary">Log In</a>
<a href="{% url 'signup' %}" class="btn btn-primary">Sign Up</a>
{% endif %}
{% endblock %}
